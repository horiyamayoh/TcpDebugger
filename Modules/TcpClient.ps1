# TcpClient.ps1
# TCP?N???C?A???g????? (?V?A?[?L?e?N?`???A?_?v?^?[????b?p?[)

function Start-TcpClientConnection {
    <#
    .SYNOPSIS
    TCP?N???C?A???g??????J?n
    
    .DESCRIPTION
    ?V?A?[?L?e?N?`????A?_?v?^?[????g?p????N???C?A???g??????J?n??????B
    #>
    param(
        [Parameter(Mandatory=$true)]
        [object]$Connection
    )
    
    # ServiceContainer???K?v
    if (-not $Global:ServiceContainer) {
        throw "ServiceContainer is not initialized. Please run TcpDebugger.ps1 first."
    }
    
    # TcpClientAdapter???èÔ
    $adapter = $Global:ServiceContainer.Resolve('TcpClientAdapter')
    
    # ManagedConnection?I?u?W?F?N?g???
    if ($Connection -is [ManagedConnection]) {
        $adapter.Start($Connection.Id)
        return
    }
    
    # ????????I?u?W?F?N?g????AConnectionService?????o?^?m?F
    if ($Connection.Id -and $Global:ConnectionService) {
        $managedConn = $Global:ConnectionService.GetConnection($Connection.Id)
        if ($managedConn) {
            $adapter.Start($Connection.Id)
            return
        }
    }
    
    # ???o?^?????G???[
    throw "Connection '$($Connection.Id)' is not registered in ConnectionService. Please use ConnectionService.AddConnection() first."
}

# Export-ModuleMember -Function 'Start-TcpClientConnection'
