# ReceivedEventHandler.ps1
# 受信イベント統合ハンドラ（AutoResponse + OnReceived）

function Invoke-ReceivedEvent {
    <#
    .SYNOPSIS
    ��M�C�x���g�����iAutoResponse��OnReceived�𓝍����s�j
    #>
    param(
        [Parameter(Mandatory=$true)]
        [string]$ConnectionId,

        [Parameter(Mandatory=$true)]
        [byte[]]$ReceivedData
    )

    $conn = Get-ManagedConnection -ConnectionId $ConnectionId

    $autoRules = @()
    if ($conn.Variables.ContainsKey('AutoResponseProfilePath')) {
        $autoPath = $conn.Variables['AutoResponseProfilePath']
        if ($autoPath) {
            try {
                $repository = Get-RuleRepository
                $autoRules = $repository.GetRules($autoPath)
            } catch {
                $autoRules = @()
            }
        }
    }

    $hasUnifiedRules = ($autoRules.Count -gt 0 -and $autoRules[0].__RuleType -eq 'Unified')

    if ($hasUnifiedRules) {
        # �����`���̏ꍇ: AutoResponse�v���t�@�C���݂̂őS����
        Invoke-ConnectionAutoResponse -ConnectionId $ConnectionId -ReceivedData $ReceivedData
    } else {
        # �ʌ`���̏ꍇ: AutoResponse��OnReceived��ʁX�Ɏ��s
        
        # 1. AutoResponse����
        if ($conn.Variables.ContainsKey('AutoResponseProfilePath') -and 
            $conn.Variables['AutoResponseProfilePath']) {
            Invoke-ConnectionAutoResponse -ConnectionId $ConnectionId -ReceivedData $ReceivedData
        }

        # 2. OnReceived����
        if ($conn.Variables.ContainsKey('OnReceivedProfilePath') -and 
            $conn.Variables['OnReceivedProfilePath']) {
            Invoke-ConnectionOnReceived -ConnectionId $ConnectionId -ReceivedData $ReceivedData
        }
    }
}
function Set-ConnectionReceivedProfiles {
    <#
    .SYNOPSIS
    接続に対してAutoResponseとOnReceivedのプロファイルを設定
    #>
    param(
        [Parameter(Mandatory=$true)]
        [string]$ConnectionId,

        [Parameter(Mandatory=$false)]
        [string]$AutoResponseProfileName,

        [Parameter(Mandatory=$false)]
        [string]$AutoResponseProfilePath,

        [Parameter(Mandatory=$false)]
        [string]$OnReceivedProfileName,

        [Parameter(Mandatory=$false)]
        [string]$OnReceivedProfilePath
    )

    $conn = Get-ManagedConnection -ConnectionId $ConnectionId

    # AutoResponseプロファイル設定
    if (-not [string]::IsNullOrWhiteSpace($AutoResponseProfilePath)) {
        if (Test-Path -LiteralPath $AutoResponseProfilePath) {
            $resolved = (Resolve-Path -LiteralPath $AutoResponseProfilePath).Path
            $conn.Variables['AutoResponseProfile'] = $AutoResponseProfileName
            $conn.Variables['AutoResponseProfilePath'] = $resolved
            Write-Host "[ReceivedEvent] AutoResponse profile '$AutoResponseProfileName' set" -ForegroundColor Green
        } else {
            Write-Warning "[ReceivedEvent] AutoResponse profile not found: $AutoResponseProfilePath"
        }
    } elseif ([string]::IsNullOrWhiteSpace($AutoResponseProfileName)) {
        # クリア
        $conn.Variables.Remove('AutoResponseProfile')
        $conn.Variables.Remove('AutoResponseProfilePath')
        Write-Host "[ReceivedEvent] AutoResponse profile cleared" -ForegroundColor Yellow
    }

    # OnReceivedプロファイル設定
    if (-not [string]::IsNullOrWhiteSpace($OnReceivedProfilePath)) {
        if (Test-Path -LiteralPath $OnReceivedProfilePath) {
            $resolved = (Resolve-Path -LiteralPath $OnReceivedProfilePath).Path
            $conn.Variables['OnReceivedProfile'] = $OnReceivedProfileName
            $conn.Variables['OnReceivedProfilePath'] = $resolved
            Write-Host "[ReceivedEvent] OnReceived profile '$OnReceivedProfileName' set" -ForegroundColor Green
        } else {
            Write-Warning "[ReceivedEvent] OnReceived profile not found: $OnReceivedProfilePath"
        }
    } elseif ([string]::IsNullOrWhiteSpace($OnReceivedProfileName)) {
        # クリア
        $conn.Variables.Remove('OnReceivedProfile')
        $conn.Variables.Remove('OnReceivedProfilePath')
        Write-Host "[ReceivedEvent] OnReceived profile cleared" -ForegroundColor Yellow
    }
}

function Get-ConnectionReceivedProfiles {
    <#
    .SYNOPSIS
    接続の受信イベントプロファイル情報を取得
    #>
    param(
        [Parameter(Mandatory=$true)]
        [string]$ConnectionId
    )

    $service = Get-ConnectionService
    if (-not $service.GetConnection($ConnectionId)) {
        return $null
    }

    $conn = Get-ManagedConnection -ConnectionId $ConnectionId

    return [PSCustomObject]@{
        AutoResponseProfile = if ($conn.Variables.ContainsKey('AutoResponseProfile')) { 
            $conn.Variables['AutoResponseProfile'] 
        } else { 
            $null 
        }
        AutoResponseProfilePath = if ($conn.Variables.ContainsKey('AutoResponseProfilePath')) { 
            $conn.Variables['AutoResponseProfilePath'] 
        } else { 
            $null 
        }
        OnReceivedProfile = if ($conn.Variables.ContainsKey('OnReceivedProfile')) { 
            $conn.Variables['OnReceivedProfile'] 
        } else { 
            $null 
        }
        OnReceivedProfilePath = if ($conn.Variables.ContainsKey('OnReceivedProfilePath')) { 
            $conn.Variables['OnReceivedProfilePath'] 
        } else { 
            $null 
        }
    }
}





